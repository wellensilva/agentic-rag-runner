name: docs

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-docs:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    env:
      PYTHONUNBUFFERED: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Guard contra trechos inválidos no app.py
        run: |
          set -e
          test -f app.py
          if grep -nE '^\s*\*\*\*' app.py; then
            echo "❌ Encontrado marcador '***' no app.py (cola incompleta)."
            exit 1
          fi
          if grep -nE '^\s*-\s*name:\s' app.py; then
            echo "❌ Parece que colou trecho de YAML do Actions dentro do app.py."
            exit 1
          fi
          echo "✓ Guard passou"

      - name: Ensure app.py present
        run: |
          test -f app.py || (echo "✗ app.py não está na raiz do repo" && exit 1)
          echo "✓ app.py encontrado"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Node (para gerar HTML/PDF)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install deps (API + docs)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          npm i redoc-cli puppeteer

      - name: Inject secrets
        run: |
          if [ -z "${{ secrets.OPENAI_API_KEY }}" ]; then
            echo "❌ OPENAI_API_KEY não configurada."
            exit 1
          fi
          echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" | tee -a $GITHUB_ENV
          echo "LLM_MODEL=gpt-4.1" | tee -a $GITHUB_ENV

          if [ -n "${{ secrets.API_ACCESS_TOKEN }}" ]; then
            echo "API_ACCESS_TOKEN=${{ secrets.API_ACCESS_TOKEN }}" | tee -a $GITHUB_ENV
          fi

      - name: Start API
        run: |
          nohup uvicorn app:app --host 127.0.0.1 --port 8000 --reload > uvicorn.log 2>&1 &
          echo $! > uv.pid
          sleep 2
          tail -n +1 uvicorn.log | sed -n '1,80p' || true

      - name: Wait /health
        run: |
          set +e
          for i in $(seq 1 60); do
            curl -fsS http://127.0.0.1:8000/health && exit 0
            sleep 2
            if [ $((i % 5)) -eq 0 ]; then
              echo "tentativa $i..."
              tail -n 60 uvicorn.log || true
            fi
          done
          echo "❌ Healthcheck falhou após ~120s"
          echo "---- uvicorn.log (FULL) ----"
          cat uvicorn.log || true
          exit 1

      - name: Download OpenAPI JSON
        run: |
          curl -fsS http://127.0.0.1:8000/openapi.json -o openapi.json
          jq .info openapi.json || true

      - name: Generate HTML docs (ReDoc)
        run: |
          npx -y redoc-cli bundle openapi.json -o api-docs.html
          test -s api-docs.html || (echo "❌ Falha ao gerar HTML" && exit 1)

      - name: Generate PDF (Chrome headless via Puppeteer)
        run: |
          node - <<'JS'
          const puppeteer = require('puppeteer');
          const path = require('path');
          (async () => {
            const browser = await puppeteer.launch({args:['--no-sandbox','--disable-setuid-sandbox']});
            const page = await browser.newPage();
            const url = 'file://' + path.join(process.cwd(), 'api-docs.html');
            await page.goto(url, { waitUntil: 'networkidle0' });
            await page.pdf({
              path: 'api-docs.pdf',
              format: 'A4',
              printBackground: true,
              margin: {top:'12mm',bottom:'12mm',left:'8mm',right:'8mm'}
            });
            await browser.close();
          })();
          JS
          test -s api-docs.pdf || (echo '❌ Falha ao gerar PDF' && exit 1)

      - name: Generate Markdown summary (endpoints)
        run: |
          python - << 'PY'
          import json
          spec = json.load(open('openapi.json','r',encoding='utf-8'))
          paths = spec.get('paths',{})
          info = spec.get('info',{})
          lines=[f"# {info.get('title','API')} — v{info.get('version','1.0')}\n","## Endpoints"]
          for p,methods in sorted(paths.items()):
            for m,desc in sorted(methods.items()):
              summ = (desc or {}).get('summary') or (desc or {}).get('operationId') or ''
              lines.append(f"- `{m.upper():6}` `{p}`  {('— '+summ) if summ else ''}")
          lines += ["\n## Como usar localmente","```bash","uvicorn app:app --host 0.0.0.0 --port 8000 --reload","open http://localhost:8000/docs","```"]
          open('api-docs.md','w',encoding='utf-8').write("\n".join(lines))
          print("Gerado api-docs.md")
          PY
          test -s api-docs.md || (echo "❌ Falha ao gerar Markdown" && exit 1)

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: api-docs
          path: |
            openapi.json
            api-docs.html
            api-docs.pdf
            api-docs.md
            uvicorn.log

      - name: Stop API
        if: always()
        run: |
          if [ -f uv.pid ] ; then kill $(cat uv.pid) || true ; fi
          pkill -f "uvicorn app:app" || true